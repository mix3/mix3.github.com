<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>20110504_02.md</title>
    <link href="/css/prettify/prettify.css" rel="stylesheet" type="text/css" media="screen" />
    <script src="/js/prettify/prettify.js" type="text/javascript"></script>
    <script src="/js/jquery-1.6.1.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        $(function(){
            $('pre').filter(function(){
                console.log($(this).parent());
                return !$(this).parent().hasClass('gist-highlight');
            }).addClass('prettyprint linenums');
            prettyPrint();
            $('#content').fadeIn(2000);
        });
    </script>
</head>
<body>
<div id="content" style="display:none">
<ul>
<li>SCPやrsyncやらで各アプリケーションサーバから回収
<ul>
<li>自由が利く</li>
</ul></li>
<li>各アプリケーションサーバから解析サーバへ投げてもらう
<ul>
<li>HDFSなどHadoopが扱うファイルシステムに直接入れる事が可能</li>
<li>※ただし、各アプリケーションサーバがそのファイルシステムを扱えるように色々セットアップが必要</li>
</ul></li>
</ul>

<p>後者のアプリから投げてもらう方だと各サーバでファイルシステムを扱えるようセットアップが必要になるので、そこまでアプリ側に負担を掛けられないかなということで今考えているのは前者の方法となります。</p>

<h3>コード</h3>

<p>Hadoopが扱うファイルシステムはHDFSという前提で前回構築した環境でサンプルを作ってみました。</p>

<h3>シェルスクリプトで並列回収</h3>

<p>まず最初にシェルスクリプトで書いてみました。「これだと回収先のアプリが100万個ある場合は100万個同時にダウンロードしちゃうってことだよね？」というもっともな指摘で没になりました。まったくもってその通りだと思います。</p>

<script src="https://gist.github.com/954830.js"> </script>

<h3>Qudoで並列回収</h3>

<ul>
<li>ジョブ／キューを使いたい
<ul>
<li>なんとなくジョブは消えてほしく無い</li>
<li>失敗したらリトライしてほしい</li>
</ul></li>
<li>回収は並列
<ul>
<li>でも同時実行数は上限あり</li>
</ul></li>
</ul>

<p>以上の要件で最初はTheSchwartz＆Parallel::Preforkで考えていましたが何やらGearmanでもDBを使って動作させられるという話があったりQudoを見つけてみたりで、でもやりたいことって別にそんなに複雑な事でもないので結局何使っても良いかなと思ってQudoを選びました。後々機能を増やしたい時にフックポイントが色々用意されているので悪くないかなと。</p>

<script src="https://gist.github.com/951476.js"> </script>

<p>どうでも良いですがnekokakさん曰くQudoは「駆動」らしいですが「弓道」の方が良いと思います＾＾</p>

</div>
</body>
</html>
