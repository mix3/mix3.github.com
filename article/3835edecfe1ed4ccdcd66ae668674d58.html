<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>20110622.md</title>
    <link href="/css/prettify/prettify.css" rel="stylesheet" type="text/css" media="screen" />
    <script src="/js/prettify/prettify.js" type="text/javascript"></script>
    <script src="/js/jquery-1.6.1.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        $(function(){
            $('pre').filter(function(){
                console.log($(this).parent());
                return !$(this).parent().hasClass('gist-highlight');
            }).addClass('prettyprint linenums');
            prettyPrint();
            $('#content').fadeIn(2000);
        });
    </script>
</head>
<body>
<div id="content" style="display:none">
<p>MobaSiFは機能がミニマムなので、コントローラに相当すると思われる部分にて以下の記述をします。</p>

<ul>
<li>アプリケーションロジックを記述</li>
<li>レスポンスの値を生成＆セット</li>
</ul>

<p>具体的に書くと以下のような感じ。</p>

<h4>conf/pages.conf</h4>

<pre><code>our %PAGE = (
    'test' =&gt; [0,0,0, 'Page::Sample', 'pageMain'],
);
</code></pre>

<h4>pm/Page/Sample.pm</h4>

<pre><code>package Page::Sample;
sub pageMain {
    my $func = shift;
    # レスポンスの生成
    my $html = HTMLTemplate::insert('sample/index', $rhData);
    # レスポンスヘッダに値をセット
    Response::output(¥$html);
}
</code></pre>

<h4>template/_system/sample/index.html</h4>

<pre><code>&lt;html&gt;
&lt;head&gt;&lt;title&gt;$CON:title$&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
    test
&lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>普段触るフレームワークだと「レスポンスの生成」も「レスポンスヘッダへの値のセット」も自分ですることはまず無くて。テンプレートに渡す値をハッシュで用意して、テンプレート自体はクエリパスなどから自動で判断するかもしくは明示的に指定するかする場合が多い。</p>

<p>ということでこの辺り結構違和感が大きいのでちょっとそれっぽくなるように手を入れてみた。</p>

<h4>pm/Context.pm</h4>

<script src="https://gist.github.com/1038137.js?file=Context.pm"></script>

<h4>pm/Page/Main.pm</h4>

<script src="https://gist.github.com/1038137.js?file=Main.pm"></script>

<h4>conf/pages.conf</h4>

<pre><code>our %PAGE = (
        .
        .
        .
    'test'  =&gt; [0,0,0, 'Page::Sample', 'test'],
    'test1' =&gt; [0,0,0, 'Page::Sample', 'test1'],
    'test2' =&gt; [0,0,0, 'Page::Sample', 'test2'],
);
</code></pre>

<h4>pm/Page/Sample.pm</h4>

<script src="https://gist.github.com/1038137.js?file=Sample.pm"></script>

<h4>template/_system/sample/test.html</h4>

<script src="https://gist.github.com/1038137.js?file=test.html"></script>

<h3>次回はDB周りを触ってみる</h3>

<p>commit,transactionなどをラップしているものの、サンプルコードではSQL直叩きなのでこれもDBICなどでゴリゴリモデルに落とし込むなどして使った方が良いかもしれない。</p>

</div>
</body>
</html>
