<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>MobaSiFを触ってみた</title>
    <link rel="alternate" type="application/rss+xml" title="RSS" href="http://mix3.github.com/index.rdf" />
    <link href="/css/prettify/prettify.css" rel="stylesheet" type="text/css" media="screen" />
    <script src="/js/prettify/prettify.js" type="text/javascript"></script>
    <script src="/js/jquery-1.6.1.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        $(function(){
            $('pre').filter(function(){
                console.log($(this).parent());
                return !$(this).parent().hasClass('gist-highlight');
            }).addClass('prettyprint linenums');
            prettyPrint();
            $('#content').fadeIn(2000);
        });
    </script>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-10744212-4']);
  _gaq.push(['_setDomainName', 'github.com']);
  _gaq.push(['_setAllowHash', 'false']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

</head>
<body>
<div id="content" style="display:none">
<h1>MobaSiFを触ってみた</h1>

<h3>インストール</h3>

<p>環境はCentOS5.6で極力yumで対処してみた。</p>

<ul>
<li>CentOS 5.6</li>
<li>Apache 2.2.3 (yum install)</li>
<li>fastcgi 2.4.0 (yum install)</li>
<li>mod_fastcgi 2.4.2 (source install)</li>
<li>mysql 5.1.57 (rpm install)</li>
<li>perl 5.8.8 (yum install)</li>
</ul>

<p>ちなみにMobaSiFのdocsに記載されている対応環境の内容は以下の通り</p>

<pre><code>           要求       確認環境
CentOS     4.x / 5.x  4.5 (i386)
Apache     1.3.x      1.3.41
MySQL      5.0.x      5.0.51a
perl       5.8.x      5.8.0
fastcgi    2.4.x      2.4.6
</code></pre>

<h3>詰まった所、注意点</h3>

<ul>
<li>MobaSiF
<ul>
<li>mod_fastcgiとmod_fcgidがあるがMobaSiFはmod_fastcgi</li>
<li>yumで入れたApacheのバージョンが2.2だったが、mod_fastcgiは2.0までしか対応していない。</li>
<li>パッチを当てれば2.2にmod_fastcgiを入れるられる⇒'Apache2.2＋fastcgiで Ruby on Rails'</li>
</ul></li>
<li>perl
<ul>
<li>FastCGIがシステム標準のperlを使うのでperlbrewを使うと混乱する。</li>
<li>素直にシステム標準のperlを使うのが楽</li>
</ul></li>
<li>Apache
<ul>
<li>MobaSiFとは全然関係ないがバーチャルホストでDocumentRootの設定に変な癖がある⇒VirtualHost環境化でのPermission Denied</li>
</ul></li>
</ul>

<h3>MobaSiFのミニマムサ</h3>

<p>ンプル</p>

<p>MobaSiFでのページとURLの対応は以下のようになる</p>

<ul>
<li>ルート
<ul>
<li>http://[domain]/</li>
</ul></li>
<li>各ページ（アンダースコア＋ページ名）
<ul>
<li>http://[domain]/[_ページ名前]</li>
</ul></li>
</ul>

<h3>ページを追加してみる</h3>

<h4>conf/pages.conf</h4>

<pre><code>our %PAGE = {
        .
        .
        .
    'sample' =&gt; [0,    package Page::Sample;

use strict;
use HTMLTemplate;
use Response;

sub pageMain {
    my $func = shift;
    my $rhData = {};

    my $html = HTMLTemplate::insert("sample/top", $rhData);
    Response::output(\$html);
}

1;0,0, 'Page::Sample', 'pageMain'],
    # http://[domain]/_sample にアクセスすると Page::SampleモジュールのpageMainの処理が走る
};
</code></pre>

<h4>pm/Page/Sample.pm</h4>

<pre><code>package Page::Sample;

use strict;
use HTMLTemplate;
use Response;

sub pageMain {
    my $func = shift;
    my $rhData = {};

    my $html = HTMLTemplate::insert("sample/top", $rhData);
    Response::output(\$html);
}

1;
</code></pre>

<h3>テンプレートのコンパイル</h3>

<p>MobaSiFでは速度を出すためにアプリで機種毎に出し分けなどの処理をしないよう最初からテンプレートを機種別に生成したりするようです。（変なバイナリデータをテンプレートに埋め込んでいたり他にも色々やってそうな感じ）</p>

<pre><code>$ perl script/tool/compile_template
</code></pre>

<h4>conf/pages.confの数字の意味</h4>

<pre><code>'ページ名' =&gt; [ UID_ST, USER_ST, SERV_ST, モジュール, サブルーチン ]
</code></pre>

<ul>
<li>UID_ST
<ul>
<li>0:情報なし</li>
<li>2:serial/uid あり</li>
</ul></li>
<li>USER_ST
<ul>
<li>0:非会員でもOK</li>
<li>1:会員（メアド未登録でもOK）</li>
<li>2:会員（メアド登録済）</li>
</ul></li>
<li>SERV_ST (以下を足したもの)
<ul>
<li>1:自主退会だと不能</li>
<li>2:運用退会だと不能</li>
<li>4:PENALTYだと不能</li>
<li>8:メール不達だと不能</li>
</ul></li>
</ul>

<h3>まとめ</h3>

<ul>
<li>機能は非常にミニマム
<ul>
<li>文字コードはテンプレートやコード等でsjis,utf8,eucが入り交じる</li>
<li>テンプレートの中に絵文字のバイナリを直接書く</li>
<li>ロジックの所でレスポンスにテンプレートと引数を合成したものの返り値を渡す処理を自分で書く。</li>
</ul></li>
</ul>

<p>⇒多分拡張して使われる事が前提と思ってよい。</p>

<ul>
<li>古いのでPlackに対応していないため、動作確認までの環境構築が非常に面倒。
<ul>
<li>開発段階でわざわざApacheとFastCGIを入れないといけない</li>
</ul></li>
</ul>

<p>⇒今時Plack対応して欲しいかも。開発段階でFastCGIがどうのとかあんまり考えたく無い。</p>

<p>以下で説明されている通りモダンじゃないのは確かかもしれませんね。 </p>

<p><a href="http://www.slideshare.net/bobpp/42php-mobasif-1351953">第42回PHP勉強会 MobaSiF 発表資料</a></p>

<!-- X:S ZenBackWidget --><script type="text/javascript">document.write(unescape("%3Cscript")+" src='http://widget.zenback.jp/?base_uri=http%3A//mix3.github.com&nsid=96368406281861426%3A%3A97485858524947259&rand="+Math.ceil((new Date()*1)*Math.random())+"' type='text/javascript'"+unescape("%3E%3C/script%3E"));</script><!-- X:E ZenBackWidget -->
</div>
</body>
</html>
